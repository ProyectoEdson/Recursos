<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitor Central - Comparativo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #0d1117; color: #e6edf3; font-family: sans-serif; padding: 20px; }
        h1 { text-align: center; color: #58a6ff; margin-bottom: 5px; }
        h3 { text-align: center; color: #8b949e; font-weight: normal; margin-top: 0; margin-bottom: 30px; }

        .dashboard { max-width: 1100px; margin: 0 auto; }

        .main-chart-container {
            background: #161b22; padding: 20px; border-radius: 12px;
            border: 1px solid #30363d; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            height: 400px;
        }

        .cards-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .mini-card {
            background: #21262d; border: 1px solid #30363d; border-radius: 12px;
            padding: 20px; cursor: pointer; text-align: left;
            transition: all 0.2s; position: relative;
            overflow: hidden;
        }
        .mini-card:hover { transform: translateY(-5px); border-color: #58a6ff; background: #30363d; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #484f58; padding-bottom: 10px; }
        .vm-name { font-weight: bold; font-size: 1.2em; color: #fff; }
        .live-dot { height: 10px; width: 10px; background-color: #2ea043; border-radius: 50%; box-shadow: 0 0 5px #2ea043; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; }
        .stat-label { color: #8b949e; }
        .stat-val { font-weight: bold; font-family: monospace; font-size: 1.1em; }

        .click-hint { font-size: 0.75em; text-align: center; color: #58a6ff; margin-top: 15px; opacity: 0.7; }

        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #161b22; width: 90%; max-width: 800px; padding: 30px;
            border-radius: 15px; border: 1px solid #58a6ff; position: relative;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 2em; cursor: pointer; color: #8b949e; }
        .close-btn:hover { color: #ff7b72; }

        .disk-bar-bg { background: #30363d; height: 15px; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .disk-bar-fill { height: 100%; background: #a371f7; width: 0%; transition: width 1s; }

    </style>
</head>
<body>

<div class="dashboard">
    <h1>üî≠ CENTRO DE CONTROL</h1>
    <h3>Infraestructura de Servidores en Tiempo Real</h3>

    <div class="main-chart-container">
        <h4 style="margin:0 0 15px 0; color:#8b949e;">Comparativa de Carga (CPU)</h4>
        <canvas id="globalChart"></canvas>
    </div>

    <h4 style="color:#8b949e; border-bottom: 1px solid #30363d; padding-bottom: 10px;">
        Estado Actual de M√°quinas
    </h4>
    <div id="cards-container" class="cards-grid">
        <p>Conectando con sat√©lites...</p>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">&times;</span>
        <h2 id="modal-title" style="color:#58a6ff; margin-top:0;">Detalle VM</h2>

        <div style="height: 300px;">
            <canvas id="detailChart"></canvas>
        </div>

        <div style="margin-top: 20px;">
            <label>üíø Almacenamiento:</label>
            <div class="disk-bar-bg">
                <div id="disk-fill" class="disk-bar-fill"></div>
            </div>
            <div id="disk-text" style="text-align: right; font-size: 0.9em; margin-top: 5px; color:#8b949e;">Calculating...</div>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://yzumpycvoouplizzgxid.supabase.co"
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6dW1weWN2b291cGxpenpneGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTI4OTYsImV4cCI6MjA4MTQ4ODg5Nn0.G9KSUWz9CtQIVs7VUwkY8BvJ1LRV9QI9-V_23m2jKGI"

    const { createClient } = supabase
    const client = createClient(SB_URL, SB_KEY)

    let globalChartRef = null;
    let detailChartRef = null;
    let allData = [];

    const COLORS = ['#ff7b72', '#2f81f7', '#2ea043', '#d2a8ff'];

    async function updateDashboard() {
        const { data, error } = await client
            .from('metricas')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(150)

        if (error) return console.error(error);

        allData = data.reverse();

        dibujarGlobalChart(allData);
        dibujarTarjetas(allData);
    }

    function dibujarGlobalChart(data) {
        const ctx = document.getElementById('globalChart').getContext('2d');

        // SOLUCI√ìN: Crear un eje de tiempo unificado para todas las VMs
        const vms = [...new Set(data.map(d => d.nombre_vm))];

        // Obtener todos los timestamps √∫nicos y ordenarlos
        const allTimestamps = [...new Set(data.map(d => d.created_at))].sort();

        // Limitar a los √∫ltimos 50 puntos para mantener la gr√°fica legible
        const maxPoints = 50;
        const timestamps = allTimestamps.slice(-maxPoints);

        // Crear etiquetas de tiempo formateadas
        const labels = timestamps.map(ts => {
            const date = new Date(ts);
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        });

        // Crear datasets: cada VM con sus datos alineados a los timestamps
        const datasets = vms.map((vmName, i) => {
            const vmData = data.filter(d => d.nombre_vm === vmName);

            // Mapear los datos de esta VM a los timestamps globales
            const alignedData = timestamps.map(ts => {
                const point = vmData.find(d => d.created_at === ts);
                return point ? parseFloat(point.cpu) : null;
            });

            return {
                label: vmName,
                data: alignedData,
                borderColor: COLORS[i % COLORS.length],
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 6,
                spanGaps: true // Conectar puntos aunque haya gaps
            }
        });

        if (globalChartRef) {
            globalChartRef.data.labels = labels;
            globalChartRef.data.datasets = datasets;
            globalChartRef.update('none');
        } else {
            globalChartRef = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#30363d' },
                            ticks: { color: '#8b949e' }
                        },
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: {
                                color: '#8b949e',
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e6edf3' },
                            position: 'top'
                        },
                        tooltip: {
                            backgroundColor: '#161b22',
                            borderColor: '#30363d',
                            borderWidth: 1
                        }
                    }
                }
            });
        }
    }

    function dibujarTarjetas(data) {
        const container = document.getElementById('cards-container');
        const uniqueVMs = {};

        data.forEach(d => uniqueVMs[d.nombre_vm] = d);

        let html = '';
        Object.values(uniqueVMs).forEach(vm => {
            const cpuColor = vm.cpu > 80 ? '#ff7b72' : '#e6edf3';
            const ramColor = vm.ram > 90 ? '#ff7b72' : '#e6edf3';

            html += `
                <div class="mini-card" onclick="abrirModal('${vm.nombre_vm}')">
                    <div class="card-header">
                        <span class="vm-name">üñ•Ô∏è ${vm.nombre_vm}</span>
                        <span class="live-dot"></span>
                    </div>

                    <div class="stats-row">
                        <span class="stat-label">üß† CPU:</span>
                        <span class="stat-val" style="color:${cpuColor}">${vm.cpu}%</span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">üíæ RAM:</span>
                        <span class="stat-val" style="color:${ramColor}">${vm.ram}%</span>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">üíø Disco:</span>
                        <span class="stat-val">${vm.disco}%</span>
                    </div>
                    <div class="click-hint">üëÜ Ver historial detallado</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function abrirModal(vmName) {
        const modal = document.getElementById('modal');
        modal.style.display = 'flex';
        document.getElementById('modal-title').innerText = vmName;

        const vmData = allData.filter(d => d.nombre_vm === vmName);
        const ultimoDato = vmData[vmData.length - 1];

        const disco = parseFloat(ultimoDato.disco);
        const barra = document.getElementById('disk-fill');
        barra.style.width = disco + '%';
        document.getElementById('disk-text').innerText = disco + '% Ocupado';

        if(disco < 60) barra.style.background = '#2ea043';
        else if(disco < 85) barra.style.background = '#e3b341';
        else barra.style.background = '#ff7b72';

        const ctx = document.getElementById('detailChart').getContext('2d');
        if (detailChartRef) detailChartRef.destroy();

        detailChartRef = new Chart(ctx, {
            type: 'line',
            data: {
                labels: vmData.map(d => new Date(d.created_at).toLocaleTimeString()),
                datasets: [
                    {
                        label: 'CPU %',
                        data: vmData.map(d => parseFloat(d.cpu)),
                        borderColor: '#ff7b72',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(255, 123, 114, 0.1)'
                    },
                    {
                        label: 'RAM %',
                        data: vmData.map(d => parseFloat(d.ram)),
                        borderColor: '#2f81f7',
                        borderDash: [5, 5],
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: '#30363d' },
                        ticks: { color: '#8b949e' }
                    },
                    x: {
                        display: false
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#e6edf3' }
                    }
                }
            }
        });
    }

    function cerrarModal() {
        document.getElementById('modal').style.display = 'none';
    }

    window.onclick = function(e) {
        if (e.target == document.getElementById('modal')) cerrarModal();
    }

    setInterval(updateDashboard, 2000);
    updateDashboard();

</script>
</body>
</html>